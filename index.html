<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f0f8ff; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤ */
            color: #343a40;
        }

        h1, h2 {
            text-align: center;
            color: #1976d2;
        }

        /* --- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï --- */
        #controlHeader {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        #resetButton, #historyButton {
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: opacity 0.2s;
        }

        #resetButton {
            background-color: #ffc107; /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á */
            color: #343a40;
        }

        #historyButton {
            background-color: #6c757d; /* ‡πÄ‡∏ó‡∏≤ */
            color: white;
        }

        /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --- */
        #statusTable {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            overflow: hidden;
        }

        #statusTable th, #statusTable td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }

        #statusTable th {
            background-color: #007bff;
            color: white;
            text-align: center;
            font-weight: 600;
        }
        
        /* ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        #statusTable td:nth-child(4),
        #statusTable td:nth-child(5),
        #statusTable td:nth-child(6),
        #statusTable td:nth-child(7) { 
            text-align: center;
        }
        
        /* ‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .status-available {
            color: #198754; 
            font-weight: bold;
        }
        .status-lunch {
            color: #dc3545; 
            font-weight: bold;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
        .lunch-button {
            padding: 5px 10px;
            font-size: 0.9em;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 120px; 
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .btn-go { background-color: #dc3545; } 
        .btn-go:hover { background-color: #c82333; }

        .btn-back { background-color: #28a745; } 
        .btn-back:hover { background-color: #1e7e34; }

        /* --- ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å (‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏µ) --- */
        .dept-sausage { background-color: #ffe0e0; } /* ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô */
        .dept-sushi { background-color: #e0f0ff; }    /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
        .dept-veggie { background-color: #e0ffec; }   /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏ó‡πå‡∏≠‡πà‡∏≠‡∏ô */
        .dept-bakery { background-color: #fffbe0; }   /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏Ñ‡∏£‡∏µ‡∏°‡∏≠‡πà‡∏≠‡∏ô */
        .dept-dairy { background-color: #f0e0ff; }    /* ‡∏°‡πà‡∏ß‡∏á‡∏•‡∏≤‡πÄ‡∏ß‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡πà‡∏≠‡∏ô */
        .dept-meat { background-color: #ffc2c2; }     /* ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô */
        .dept-seafood { background-color: #e0fff9; }  /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ó‡∏∞‡πÄ‡∏•‡∏≠‡πà‡∏≠‡∏ô */
        
        /* ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
        .dept-sausage:nth-child(odd) { background-color: #ffd0d0; } 
        .dept-sushi:nth-child(odd) { background-color: #c8e8ff; } 
        .dept-veggie:nth-child(odd) { background-color: #c8ffe0; } 
        .dept-bakery:nth-child(odd) { background-color: #fff5c8; } 
        .dept-dairy:nth-child(odd) { background-color: #e8d0ff; }
        .dept-meat:nth-child(odd) { background-color: #ffadad; }
        .dept-seafood:nth-child(odd) { background-color: #c8fff5; }

        /* --- Modal (‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥) --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.6); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        #historyContent pre {
            white-space: pre-wrap;
            background-color: #eee;
            padding: 15px;
            border-radius: 4px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h1>

    <div id="controlHeader">
        <button id="resetButton" onclick="resetAllStatusesWithCode()">
            ‚ö†Ô∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô)
        </button>
        <button id="historyButton" onclick="showHistory()">
            üìö ‡∏î‡∏π‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
        </button>
    </div>
    
    <h2>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <table id="statusTable">
        <thead>
            <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏õ‡∏û‡∏±‡∏Å</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö</th>
                <th>‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å</th>
                <th>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th> 
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï)</h2>
            <div id="historyContent">
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>
    </div>

    <script>
        // --- ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ---
        const EMPLOYEES_DATA = [
            // ‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏Å-‡πÅ‡∏Æ‡∏°
            { id: 'sausage_1', name: '‡∏£‡∏ß‡∏¥‡∏ß‡∏£‡∏£‡∏ì ‡∏ä‡∏≥‡∏ô‡∏≤‡∏ô‡πÄ‡∏û‡∏≤‡∏∞', dept: '‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏Å-‡πÅ‡∏Æ‡∏°', class: 'dept-sausage' },
            { id: 'sausage_2', name: '‡∏û‡∏±‡∏ä‡∏£‡∏µ ‡∏™‡∏∏‡∏Ç‡πÅ‡∏™‡∏ß‡∏á', dept: '‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏Å-‡πÅ‡∏Æ‡∏°', class: 'dept-sausage' },
            // ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô
            { id: 'sushi_1', name: '‡∏®‡∏¥‡∏£‡∏¥‡∏ò‡∏£ ‡∏ä‡∏±‡∏¢‡πÄ‡∏ß‡∏ó‡∏¢‡πå', dept: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô', class: 'dept-sushi' },
            { id: 'sushi_2', name: '‡∏ò‡∏µ‡∏£‡∏ß‡∏±‡∏í‡∏ô‡πå ‡∏ö‡∏±‡∏ß‡πÅ‡∏Å‡πâ‡∏ß', dept: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô', class: 'dept-sushi' },
            // ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏±‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ
            { id: 'veggie_1', name: '‡∏Æ‡∏≤‡∏ö‡∏µ‡∏ö‡∏∞ ‡πÇ‡∏î‡πÇ‡∏ã‡∏°‡∏¥', dept: '‡∏ú‡∏±‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ', class: 'dept-veggie' },
            { id: 'veggie_2', name: '‡∏°‡∏≤‡∏£‡∏µ‡∏ô‡∏≤ ‡∏î‡∏±‡πâ‡∏ô‡∏î‡∏µ', dept: '‡∏ú‡∏±‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ', class: 'dept-veggie' },
            // ‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà
            { id: 'bakery_1', name: '‡∏™‡∏£‡∏¥‡∏ô‡∏¢‡∏≤ ‡∏™‡∏≤‡∏£‡∏¥‡∏¢‡∏≤', dept: '‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà', class: 'dept-bakery' },
            // ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏°-‡∏ä‡∏µ‡∏™
            { id: 'dairy_1', name: '‡∏ô‡∏≤‡∏®‡∏£‡∏¥‡∏ç ‡πÇ‡∏°‡∏á', dept: '‡∏ô‡∏°-‡∏ä‡∏µ‡∏™', class: 'dept-dairy' },
            { id: 'dairy_2', name: '‡∏≠‡∏±‡∏™‡∏ß‡∏≤‡∏ô ‡∏≠‡∏≤‡πÅ‡∏ß', dept: '‡∏ô‡∏°-‡∏ä‡∏µ‡∏™', class: 'dept-dairy' },
            // ‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠
            { id: 'meat_1', name: '‡∏à‡∏±‡∏Å‡∏£‡∏Å‡∏£‡∏¥‡∏ä ‡∏™‡∏°‡∏≤‡∏ô', dept: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', class: 'dept-meat' },
            // ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î
            { id: 'seafood_1', name: '‡∏≠‡∏¥‡∏™‡∏°‡∏≤‡πÅ‡∏≠ ‡∏™‡∏≤‡πÄ‡∏•‡πá‡∏á', dept: '‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î', class: 'dept-seafood' },
        ];
        
        const LOCAL_STORAGE_KEY = 'employeeLunchStatusV4';
        const HISTORY_KEY = 'employeeLunchHistory';
        const LAST_RESET_KEY = 'lastResetDate';
        const RESET_PASSWORD = '254130'; 

        let allStatuses = {}; 

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ---

        function formatTime(dateString) {
            if (!dateString) return '-';
            try {
                const d = new Date(dateString);
                if (isNaN(d.getTime())) return '-';
                return d.toLocaleTimeString('th-TH', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
            } catch (e) { return '-'; }
        }

        function calculateDuration(startTimeString, endTimeString) {
            if (!startTimeString || !endTimeString) return '-';
            
            const startDate = new Date(startTimeString);
            const endDate = new Date(endTimeString);
            
            const durationMs = endDate - startDate;
            if (durationMs < 0) return '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏ß‡∏•‡∏≤';
            
            const hours = Math.floor(durationMs / (1000 * 60 * 60));
            const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((durationMs % (1000 * 60)) / 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Local Storage ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ---
        
        function getInitialStatus() {
            return { 
                isAvailable: true, 
                lunchStart: null, 
                lunchEnd: null,
                duration: '-'
            };
        }

        function loadAllStatuses() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            try {
                allStatuses = savedData ? JSON.parse(savedData) : {};
            } catch (e) {
                allStatuses = {};
            }
            
            EMPLOYEES_DATA.forEach(emp => {
                if (!allStatuses[emp.id]) {
                    allStatuses[emp.id] = getInitialStatus();
                }
            });
        }

        function saveAllStatuses() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allStatuses));
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ---
        
        function resetAllStatusesWithCode() {
            const inputCode = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:");
            
            if (inputCode === RESET_PASSWORD) {
                if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô?")) {
                    performReset(true);
                    alert("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
                }
            } else if (inputCode !== null) {
                alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏î‡πâ");
            }
        }
        
        function performReset(isManual) {
            if (!isManual) {
                const lastResetDate = localStorage.getItem(LAST_RESET_KEY);
                if (lastResetDate === getTodayDateString()) {
                    return; 
                }
            }

            const historyRecord = {
                date: new Date().toISOString(),
                statusData: allStatuses
            };
            localStorage.setItem(HISTORY_KEY, JSON.stringify(historyRecord));

            EMPLOYEES_DATA.forEach(emp => {
                allStatuses[emp.id] = getInitialStatus();
            });
            
            saveAllStatuses();
            localStorage.setItem(LAST_RESET_KEY, getTodayDateString());
            updateTable();
        }

        function checkAutoReset() {
            const now = new Date();
            const lastResetDate = localStorage.getItem(LAST_RESET_KEY);
            
            if (lastResetDate !== getTodayDateString() && now.getHours() === 0 && now.getMinutes() === 0) {
                performReset(false);
                console.log("Auto-reset completed at 00:00.");
            }
        }
        
        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ---
        
        function showHistory() {
            const historyData = localStorage.getItem(HISTORY_KEY);
            const contentDiv = document.getElementById('historyContent');
            const modal = document.getElementById('historyModal');
            
            if (!historyData) {
                contentDiv.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>';
            } else {
                const record = JSON.parse(historyData);
                let historyHTML = `<h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(record.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</h3>`;
                historyHTML += '<pre>';
                
                EMPLOYEES_DATA.forEach(emp => {
                    const status = record.statusData[emp.id];
                    if (status) {
                        const start = formatTime(status.lunchStart);
                        const end = formatTime(status.lunchEnd);
                        const duration = status.duration;
                        const finalStatus = status.isAvailable ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : '‡∏û‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á';

                        historyHTML += `[${emp.dept}] ${emp.name}:\n`;
                        historyHTML += `  ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ${finalStatus}\n`;
                        historyHTML += `  ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏±‡∏Å: ${start}\n`;
                        historyHTML += `  ‡∏Å‡∏•‡∏±‡∏ö: ${end}\n`;
                        historyHTML += `  ‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å: ${duration}\n\n`;
                    }
                });
                
                historyHTML += '</pre>';
                contentDiv.innerHTML = historyHTML;
            }
            
            modal.style.display = "block"; 
        }

        function closeModal() {
            document.getElementById('historyModal').style.display = "none";
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ---

        function updateTable() {
            const tbody = document.querySelector('#statusTable tbody');
            tbody.innerHTML = ''; 
            
            const sortedEmployees = [...EMPLOYEES_DATA].sort((a, b) => a.dept.localeCompare(b.dept, 'th'));

            sortedEmployees.forEach(emp => {
                const status = allStatuses[emp.id];
                const row = tbody.insertRow();
                
                // *** ‡πÄ‡∏û‡∏¥‡πà‡∏° Class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ñ‡∏ß ***
                row.className = emp.class;

                const statusClass = status.isAvailable ? 'status-available' : 'status-lunch';
                const statusText = status.isAvailable ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : '‡∏û‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á';
                
                // *** ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥) ***
                row.insertCell().textContent = emp.name;
                
                row.insertCell().textContent = emp.dept;
                
                const statusCell = row.insertCell();
                statusCell.className = statusClass;
                statusCell.textContent = statusText;

                row.insertCell().textContent = formatTime(status.lunchStart);
                row.insertCell().textContent = formatTime(status.lunchEnd);
                row.insertCell().textContent = status.duration;

                const controlCell = row.insertCell();
                controlCell.innerHTML = createControlButton(emp.id, status.isAvailable);
            });
        }
        
        function createControlButton(employeeId, isAvailable) {
            if (isAvailable) {
                return `<button class="lunch-button btn-go" onclick="toggleStatus('${employeeId}', false)">
                            ‚è∏Ô∏è ‡πÑ‡∏õ‡∏û‡∏±‡∏Å
                        </button>`;
            } else {
                return `<button class="lunch-button btn-back" onclick="toggleStatus('${employeeId}', true)">
                            ‚ñ∂Ô∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏Å
                        </button>`;
            }
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
        
        function toggleStatus(employeeId, nextStatus) {
            const now = new Date().toISOString(); 
            let status = allStatuses[employeeId];
            
            if (status.isAvailable === nextStatus) return; 

            status.isAvailable = nextStatus; 

            if (!status.isAvailable) {
                status.lunchStart = now;
                status.lunchEnd = null; 
                status.duration = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å...';
                
            } else {
                status.lunchEnd = now;
                
                if (status.lunchStart) {
                    status.duration = calculateDuration(status.lunchStart, status.lunchEnd);
                } else {
                    status.duration = 'N/A (‡∏Ç‡∏≤‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)';
                }
            }
            
            allStatuses[employeeId] = status;
            saveAllStatuses(); 
            updateTable(); 
        }

        // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Initialisation) ---
        
        loadAllStatuses(); 
        updateTable(); 
        
        setInterval(checkAutoReset, 60000); 
        checkAutoReset(); 

        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>